# Phase 2.5: IGP 成本与效果评估 - 完成总结

## 概述

Phase 2.5 对 IGP (Iterative Graph Pruning) 进行了量化评估，比较启用和禁用 IGP 时的 RAG 查询性能。

## 测试配置

- **测试集**: Phase 0.1 的 6 个单 PDF 问题 (Q01-Q04b)
- **IGP 策略**: topK (保留 IG 得分最高的 K 个 chunks)
- **IGP topK**: 5
- **基线 topK**: 15 (初始检索数量)
- **日期**: 2026-01-27

## 评估结果

### 总体指标

| 指标 | 结果 | 目标 | 状态 |
|------|------|------|------|
| 平均质量变化 | **-33.3%** | ≥-10% | ❌ 未达标 |
| 平均 Chunk 减少 | **68.3%** | ≥50% | ✅ 达标 |
| 平均响应时间增加 | **1.37x** | <2x | ✅ 达标 |
| 平均 Faithfulness 变化 | **-0.17** | ≥0 | ❌ 略有下降 |

### 质量分布

| 分类 | 数量 | 占比 |
|------|------|------|
| 质量提升 (Δ > +5%) | 0 | 0% |
| 质量持平 (±5%) | 4 | 67% |
| 质量下降 (Δ < -5%) | 2 | 33% |

### 逐问题结果

| 问题 | 基线分数 | IGP分数 | 质量变化 | 时间变化 | Chunk减少 |
|------|----------|---------|----------|----------|-----------|
| Q01 (F1提升百分比) | 1.0 | 1.0 | 0% | 0.90x ⬇️ | 67% |
| Q02 (Token减少倍数) | 1.0 | **0.0** | **-100%** | 1.28x | 67% |
| Q03 (公式因素) | 1.0 | 1.0 | 0% | 1.60x | 69% |
| Q04 (三阶段) | 0.5 | 0.5 | 0% | 1.03x | 71% |
| Q04a (表格F1) | 1.0 | **0.0** | **-100%** | 2.38x | 67% |
| Q04b (架构图) | 0.5 | 0.5 | 0% | 1.05x | 71% |

## 失败案例分析

### Q02: Token 减少倍数 (分数 1.0 → 0.0)

**基线答案** (正确):
> SimpleMem 相比 full-context 模型减少了约 **30 倍** 的 token 消耗

**IGP答案** (错误):
> SimpleMem 相比 full-context 模型减少了约 **10 倍** 的 token 消耗

**原因分析**:
- IGP 剪枝保留了图表数据 chunk，但丢弃了包含 "30x" 精确数值的文本 chunk
- IG 评分倾向于保留"信息增益高"的 chunks，但精确数值不一定在高 IG chunk 中

### Q04a: 表格 F1 分数 (分数 1.0 → 0.0)

**基线答案** (正确):
> SimpleMem 在 GPT-4.1-mini 上的 Average F1 分数为 **43.24**

**IGP答案** (错误):
> The context does not provide the Average F1 score for SimpleMem on GPT-4.1-mini

**原因分析**:
- IGP 剪枝丢弃了包含 "43.24" 数值的表格 chunk
- IG 评分基于"回答 query 的不确定性减少"，但表格数据的 IG 评分可能不高
- 这是一个 **精确数值提取** 任务，IGP 的语义剪枝策略不适合

## 关键发现

### 1. IGP 不适合精确数值提取任务

IGP 基于 IG (信息增益) 进行剪枝，IG 衡量的是 chunk 对"回答问题不确定性"的减少。但对于：
- 精确数字提取 (Q02: 30x, Q04a: 43.24)
- 表格数据查询

这类任务需要 **精确匹配** 而非 **语义相关性**。IGP 可能丢弃包含关键数值的 chunks。

### 2. Chunk 减少显著

从 15-17 chunks 减少到 5 chunks (68.3%)，达到目标 (>50%)。

### 3. 响应时间增加可控

平均增加 1.37x，在可接受范围内 (<2x)。但 IGP 本身需要 10-18 秒（约占总时间 30-50%）。

### 4. 质量不稳定

- 4/6 问题质量持平
- 2/6 问题质量严重下降 (从 1.0 降到 0.0)

## 决策：DISCARD

根据评估结果，**建议放弃 IGP 作为默认功能**：

### 放弃原因

1. **质量下降超阈值**: -33.3% (阈值 < -10%)
2. **不适合精确数值任务**: 2 个问题完全失败
3. **风险大于收益**: Chunk 减少虽显著，但可能丢弃关键信息

### 保留策略

虽然不推荐默认启用，IGP 可在以下场景**可选启用**：

1. **语义理解任务**: 概念解释、架构描述等不需要精确数值的问题
2. **Token 敏感场景**: LLM 上下文长度受限时，作为降级方案
3. **跨多 Bundle 查询**: 初始 chunk 数量很大时，需要激进剪枝

## 代码影响

### 默认配置 (保持不变)
```typescript
// src/rag/types.ts
igpOptions: { enabled: false }  // 默认禁用
```

### 可选启用 (用户选择)
```typescript
// 仅在语义理解任务中启用
await ragQuery(question, {
  igpOptions: {
    enabled: true,
    strategy: 'topK',
    topK: 8,  // 适当增加保留数量
  },
});
```

## 后续优化建议

如果未来要改进 IGP：

1. **混合策略**: 保留所有 pdf_table 类型的 chunks，仅对 pdf_text 进行 IGP
2. **自适应 topK**: 根据问题类型动态调整 topK (数值提取任务增加 topK)
3. **优化 IG 计算**: 考虑 chunk 的 sourceType 和 content type 作为权重因子

## 文件变更

### 新建文件
- `scripts/evaluate-igp.ts` (429 行) - IGP 评估脚本
- `tests/benchmarks/igp-evaluation-results.json` - 评估结果

### 无代码修改

IGP 功能已实现但默认禁用，不影响现有功能。

## Phase 2 完成状态

- [x] Phase 2.1: LLM Logprobs 接口验证
- [x] Phase 2.2: NU 计算器
- [x] Phase 2.3: IG 排序器
- [x] Phase 2.4: IGP 剪枝器集成
- [x] Phase 2.5: IGP 成本与效果评估 (**决策: DISCARD**)

## 下一步

Phase 2 完成。可以进入 Phase 3 或其他优化方向。
